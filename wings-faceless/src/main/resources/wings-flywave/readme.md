# 数据库约定

本约定基于经验的积累，属于当前场景下的最佳实践。
并且，数据版本的管理，数据跟踪的功能严格依赖此约定。

所有结构变更，都必须通过sql进行。静态数据建议使用sql。

所有sql文件，按以下约定的顺序（增序）执行。

## 版本号

`版本号`(revision)=`版本号`+`修订号`。
`版本号`的初始值是`2019051201`,任何小于此值都被忽略。

## 主版号

`主版号`(version/major)，使用yyMMdd的方式表述，一共6位数字。

版本号要求严格递增，但不要求连续。

同一天内若有多人修改，应做好沟通，统一修改。

## 修订号

`修订号`(build)，是小版本号，从`01`到`99`，2位数字。

严格递增，不要求连续。

## 标志位

`标志位`用来表示行为，小写字母，目前只有`v`表示执行，`u`表示撤销。

## 信息部

`-`+英文信息，单词间以`_`或`-`分隔为好。
该部分为可选项，只用来人工识别文件用，程序处理时忽略。

## 文件名

文件名由`版本号`+`标志位`+`修订号`+`信息部`构成，`.sql`扩展名，全小写。

 * 20190521u01-my_test.sql
 * 20190521v01.sql

## 升级脚本

升级已 `v` 表示，是version的意思（也叫upto），必须存在。

`20190509_v_01.sql`表示升级版本。

## 降级脚本

降级以`u`表示，是undo的意思，可以不存在。

`20190509_u_01.sql`是`20190509_v_01.sql`的降级。

降级需要做 `exists` 检测，有先于升级脚本执行的容错能力。

执行时，默认先执行降级脚本。

## SQL格式化

 * 一个字段放一行（不换行）。
 * 表和字段要有注释。
 * 脚本要有分隔符`;`
 * 完整语句间留有空行。
 * 所有表名，字段，索引，触发器名，可以有`` ` `` 转译
 * 有效命名字符有`A-Z`,`0-9`，`_`和`$`，建议全大写或全小写
 * `$`会在flywave分表替换中作为名字分隔符
 
 以空行分开的SQL段，是一个执行单元。
 要求一个执行单元，只有一条SQL语句。