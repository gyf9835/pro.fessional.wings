# wings升级到2.6.3.210手册

build版从201升级210，有以下重点不兼容影响。

* java以11，取代8，其编译及启动参数变化
* boot以2.6升级到2.4，其webmvc，路径匹配有变
* shardingsphere以5.0取代4.1，其结构更优
* flywave以`__`取代`$`机制，以兼容云db功能
* swagger以springdoc取代springfox，以兼容boot2.6

## pom.xml修改

若以parent形式开始的项目，直接修改version，然后重新import即可
``` xml
<parent>
    <groupId>pro.fessional</groupId>
    <artifactId>wings-project</artifactId>
    <version>2.6.3.210-SNAPSHOT</version>
</parent>
```

## java11的重要变更

当前使用的java11为[openjdk build 11.0.2+9](https://jdk.java.net/archive/)，
推荐以[sdkman](https://sdkman.io/)管理java8及java11环境，并在shell中设置`JDK8_HOME`和`JDK11_HOME`变量。

IDEA或maven启动java程序及TestCast时，需要响应的增加add-opens或add-exports参数
* maven-compiler-plugin - add-exports 编译
* maven-surefire-plugin - add-opens 运行
* IDEA运行TestCase - 自动获取surefire配置
* IDEA运行Java和Boot - 手工设置启动参数模板，
  
其中启动参数为`${wings.java-opens}`内容，不推荐全局变量，如JAVA_TOOL_OPTIONS。
IDEA中需要在`Run/Debug Configuration Templates`中分别设置`Application`和`Spring Boot`

参考资料
* [What's the difference between --add-exports and --add-opens ...](https://stackoverflow.com/questions/44056405)
* [How can I specify --add-opens from a project level ...](https://stackoverflow.com/questions/70196098)

## flywave下划线命名策略

主要是log表，从dollar变为double underline体系，trigger后缀表前缀。

* log表从`table$log` 变为`table__`
* trigger从`table$ai` 变为`ai__table`

操作步骤如下，

* 手工rename journal table
* 使用flywave journal程序生成trigger

```sql
SELECT
    table_name,
    CONCAT('ALTER TABLE ',table_name,' RENAME TO ', REPLACE(table_name, '$log','__'), ';')
FROM INFORMATION_SCHEMA.TABLES
WHERE table_schema = DATABASE()
  AND table_name REGEXP '\\$log';
```

## lombok移除var

import lombok.var;

```bash
find . -type f -name '*.java' | while read -r fl; do
sed -i '' -E 's/import lombok.var;//g' $fl
done
```

## Swagger3.0注解

springdoc全面使用OpenApi/Swagger3.0，因此springfox的Swagger2.0注解需要替换
具体细节参考 https://springdoc.org/#migrating-from-springfox

```bash
# 查看 swagger2的注解
find . -type f -name '*.java' | while read -r fl; do
grep 'import io.swagger.annotations' $fl >> /tmp/swagger.log
done
sort /tmp/swagger.log | uniq
rm -f /tmp/swagger.log

# 替换常用标签，自行修改格式偏差引发的编译错误
find . -type f -name '*.java' | while read -r fl; do
sed -i '' -E 's/import io.swagger.annotations.ApiModel;/import io.swagger.v3.oas.annotations.media.Schema;/g' $fl
sed -i '' -E 's/import io.swagger.annotations.ApiModelProperty;/import io.swagger.v3.oas.annotations.media.Schema;/g' $fl
sed -i '' -E 's/import io.swagger.annotations.Api;/import io.swagger.v3.oas.annotations.tags.Tag;/g' $fl
sed -i '' -E 's/import io.swagger.annotations.ApiOperation;/import io.swagger.v3.oas.annotations.Operation;/g' $fl

sed -i '' -E 's/@ApiModel\((.*)\)/@Schema(description = \1)/g' $fl
sed -i '' -E 's/@ApiModelProperty\((.*)\)/@Schema(description = \1)/g' $fl
sed -i '' -E 's/@Api\((.*)\)/@Tag(name = \1)/g' $fl
sed -i '' -E 's/@ApiOperation\((.*)\)/@Operation(summary = \1)/g' $fl
done
```
