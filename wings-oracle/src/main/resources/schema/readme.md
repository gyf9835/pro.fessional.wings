# 数据库约定

本约定基于经验的积累，属于当前场景下的最佳实践。
并且，数据版本的管理，数据跟踪的功能严格依赖此约定。

所有结构变更，都必须通过sql进行。静态数据建议使用sql。

所有sql文件，按以下约定的顺序（增序）执行。

## 版本号

`版本号`，使用yyMMdd的方式表述，一共6位数字。

版本号要求严格递增，但不要求连续。

同一天内若有多人修改，应做好沟通，统一修改。

## 修订号

`修订号`，是小版本号，从`01`到`99`，2位数字。

严格递增，不要求连续。

## 标志位

`标志位`用来表示行为，小写字母，目前只有`v`表示执行，`u`表示撤销。

## 文件名

文件名由`版本号`_`标志位`_`修订号`构成，`.sql`扩展名，全小写。

## 升级脚本

升级已 `v` 表示，是version的意思，必须存在。

`20190509_v_01.sql`表示升级版本。

## 降级脚本

降级以`u`表示，是undo的意思，可以不存在。

`20190509_u_01.sql`是`20190509_v_01.sql`的降级。

降级需要做 `exists` 检测，有先于升级脚本执行的容错能力。

执行时，默认先执行降级脚本。

## SQL格式化

 * 一个字段放一行（不换行）。
 * 表和字段要有注释。
 * 脚本要有分隔符`;`
 * 完整语句间留有空行。
 * 所有表名，字段，索引，触发器名，有`` ` `` 转译
 
 以空行分开的SQL段，是一个执行单元。
 要求一个执行单元，只有一条SQL语句。

## 版本管理

根据`SYS_SCHEMA_MANAGER`，以下任意字段为`1`时，自动创建 `*$log`表。

 * 根据`LOG_UPDATE`创建 `before update` 触发器。
 * 根据`LOG_DELETE`创建 `before delete` 触发器。

## 水平分表

根据sharding-jdbc中的配置，会自动进行分表操作（index或trigger存在语法解析问题）。
所以，此功能，只是用字符串替换功能，需要人工书写SQL时注意规则。


